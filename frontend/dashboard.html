// ===== Form Elements =====
const signInForm = document.getElementById("sign-in-form");
const signUpForm = document.getElementById("sign-up-form");
const forgotForm = document.getElementById("forgot-form");
let currentFormType = "";
let forgotEmail = "";

// ===== Modal Creation (if not already present) =====
function createModals() {
  if (!document.getElementById("captchaModal")) {
    const captchaModal = document.createElement('div');
    captchaModal.id = 'captchaModal';
    captchaModal.className = 'modal';
    captchaModal.style.display = 'none';
    captchaModal.innerHTML = `
      <div class="modal-content">
        <h3>Please verify you're human</h3>
        <p id="captcha-question">Loading captcha...</p>
        <input type="text" id="captcha-answer" placeholder="Your answer" />
        <div class="modal-buttons">
          <button id="verifyCaptchaBtn">Verify</button>
        </div>
      </div>`;
    document.body.appendChild(captchaModal);
  }

  if (!document.getElementById("otpModal")) {
    const otpModal = document.createElement('div');
    otpModal.id = 'otpModal';
    otpModal.className = 'modal';
    otpModal.style.display = 'none';
    otpModal.innerHTML = `
      <div class="modal-content">
        <h3>Enter OTP sent to your email</h3>
        <input type="text" id="otpInput" placeholder="Enter OTP" />
        <div class="modal-buttons">
          <button id="verifyOtpBtn">Verify OTP</button>
        </div>
      </div>`;
    document.body.appendChild(otpModal);
  }
}

// ===== Captcha Logic =====
function generateCaptcha() {
  const num1 = Math.floor(Math.random() * 10);
  const num2 = Math.floor(Math.random() * 10);
  document.getElementById("captcha-question").textContent = `What is ${num1} + ${num2}?`;
  return num1 + num2;
}

function showCaptchaModal(formType) {
  currentFormType = formType;
  const answer = generateCaptcha();
  document.getElementById("captchaModal").style.display = 'flex';
  document.getElementById("verifyCaptchaBtn").dataset.answer = answer;
}

// ===== Form Switching =====
function hideAllForms() {
  signInForm.classList.remove("active");
  signUpForm.classList.remove("active");
  forgotForm.classList.remove("active");
}

function switchForm(type) {
  hideAllForms();
  if (type === 'signin') signInForm.classList.add("active");
  else if (type === 'signup') signUpForm.classList.add("active");
  else if (type === 'forgot') forgotForm.classList.add("active");
}

document.querySelectorAll("#show-signup").forEach(el => el.addEventListener("click", () => switchForm('signup')));
document.querySelectorAll("#show-signin").forEach(el => el.addEventListener("click", () => switchForm('signin')));
document.querySelectorAll("#show-forgot").forEach(el => el.addEventListener("click", () => switchForm('forgot')));
document.getElementById("back-to-signin").addEventListener("click", () => switchForm('signin'));

// ===== Form Submission Events =====
signInForm.addEventListener("submit", e => {
  e.preventDefault();
  showCaptchaModal("signin");
});

signUpForm.addEventListener("submit", e => {
  e.preventDefault();
  showCaptchaModal("signup");
});

forgotForm.addEventListener("submit", e => {
  e.preventDefault();
  const newPass = document.getElementById("new-password").value;
  const confirmPass = document.getElementById("confirm-new-password").value;
  if (newPass !== confirmPass) {
    alert("Passwords don't match!");
    return;
  }
  showCaptchaModal("forgot");
});

// ===== OTP Flow =====
async function showOtpModal() {
  let email = "";

  if (currentFormType === "signup") {
    email = document.getElementById("signup-email").value;
  } else if (currentFormType === "forgot") {
    const username = document.getElementById("forgot-username").value;

    const res = await fetch("http://localhost:5000/get-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username }),
    });

    const result = await res.json();
    if (!result.success) {
      alert("Email not found for this username.");
      return;
    }

    email = result.email;
    forgotEmail = email;
  }

  const response = await fetch("http://localhost:5000/send-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email }),
  });

  const data = await response.json();
  if (data.success) {
    document.getElementById("otpModal").style.display = 'flex';
    document.getElementById("otpInput").value = "";
    console.log("ðŸ“¬ OTP sent to:", email);
  } else {
    alert("Failed to send OTP: " + data.message);
  }
}

async function verifyOtp() {
  const otp = document.getElementById("otpInput").value;
  let email = currentFormType === "signup"
    ? document.getElementById("signup-email").value
    : forgotEmail;

  const response = await fetch("http://localhost:5000/verify-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, otp }),
  });

  const data = await response.json();
  if (data.success) {
    document.getElementById("otpModal").style.display = 'none';

    if (currentFormType === "signup") {
      await sendSignupRequest();
    } else if (currentFormType === "forgot") {
      await sendForgotPasswordRequest(otp);
    }
  } else {
    alert("Invalid OTP. Try again.");
  }
}

// ===== Request Functions =====
async function sendSignupRequest() {
  const username = document.getElementById("signup-username").value;
  const email = document.getElementById("signup-email").value;
  const password = document.getElementById("signup-password").value;
  const confirm_password = document.getElementById("signup-confirm-password").value;

  const response = await fetch("http://localhost:5000/signup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, email, password, confirm_password }),
  });

  const data = await response.json();
  if (data.success) {
    alert("Signup successful! Check your email.");
    switchForm("signin");
  } else {
    alert("Signup failed: " + data.error);
  }
}

async function handleLogin() {
  const username = document.getElementById("signin-username").value;
  const password = document.getElementById("signin-password").value;

  const response = await fetch("http://localhost:5000/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password }),
  });

  const data = await response.json();
  if (data.success) {
    localStorage.setItem("loggedIn", "true");  // âœ… store login state
    alert("Login successful!");
    window.location.href = "dashboard.html";   // âœ… redirect to dashboard
  } else {
    alert("Login failed: " + data.error);
  }
}

async function sendForgotPasswordRequest(otp) {
  const username = document.getElementById("forgot-username").value;
  const new_password = document.getElementById("new-password").value;
  const confirm_password = document.getElementById("confirm-new-password").value;

  const response = await fetch("http://localhost:5000/forgot-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, new_password, confirm_password, otp }),
  });

  const data = await response.json();
  if (data.success) {
    alert("Password reset successful!");
    switchForm("signin");
  } else {
    alert("Reset failed: " + data.error);
  }
}

// ===== Captcha Verification =====
function verifyCaptcha() {
  const userAnswer = parseInt(document.getElementById("captcha-answer").value);
  const correctAnswer = parseInt(document.getElementById("verifyCaptchaBtn").dataset.answer);

  if (userAnswer === correctAnswer) {
    document.getElementById("captchaModal").style.display = 'none';

    if (currentFormType === "signin") {
      handleLogin();
    } else {
      showOtpModal(); // âœ… call OTP modal after captcha
    }
  } else {
    alert("Incorrect captcha. Try again.");
    generateCaptcha();
  }
}

// ===== Init =====
createModals();
document.addEventListener("click", (e) => {
  if (e.target.id === "verifyCaptchaBtn") verifyCaptcha();
  if (e.target.id === "verifyOtpBtn") verifyOtp();
});
switchForm("signin");
